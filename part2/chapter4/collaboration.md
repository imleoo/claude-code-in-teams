# 实时协作与沟通机制

当团队从“单人与AI共舞”进入“多人与AI共创”的阶段时，我们就必须建立一套清晰的协作与沟通机制，否则很容易陷入“AI越强，团队越乱”的困境。本节将介绍几种核心机制，以确保多线程的AI协作能够和谐、高效地进行。

## 核心挑战：无形的“AI拥堵”

在传统开发中，协作的冲突点是明确的（如Git合并冲突）。但在AI协作中，冲突变得更加“无形”：

- **重复工作**：两名开发者可能在不知情的情况下，让AI去解决同一个问题。
- **上下文污染**：A开发者与AI的对话，可能无意中影响了B开发者在共享会话中的结果。
- **目标漂移**：不同成员对AI下达了微小但方向不一的指令，导致最终产出物偏离了统一目标。

要解决这些问题，我们需要在物理隔离、会话管理和团队沟通三个层面建立规范。

## 1. 物理隔离：Git Worktrees 多会话并行开发

在AI协作开发中，我们强烈推荐使用 **Git Worktrees**。它允许你为同一个仓库检出多个工作树（目录），每一个工作树都可以对应一个独立的分支。

**为什么它对AI协作至关重要？**
- **独立的上下文环境**：每个worktree都是一个独立的目录，有自己的文件状态和`node_modules`。这意味着你可以在`feature-A`的worktree中让AI进行大范围重构，而完全不影响你在`feature-B`的worktree中进行稳定的开发。
- **避免分支切换污染**：传统的`git checkout`会改变整个工作区，可能导致AI或IDE的索引混乱。Worktree则完全避免了这个问题。
- **无缝并行开发**：你可以同时打开多个VS Code窗口，分别对应不同的worktree，实现真正的并行开发，每个窗口都可以有一个独立的AI会话。

**实践工作流：**
```bash
# 1. 为新功能创建一个 worktree
# 这会在 ../claude-book-feature-A 目录下创建一个与主项目隔离的环境
git worktree add ../claude-book-feature-A feature/new-feature-A

# 2. 进入新的 worktree 并开始工作
cd ../claude-book-feature-A
# 在这里，你可以自由地让AI进行任何操作
code . # 在新VS Code窗口中打开

# 3. 完成后，像正常分支一样推送
git push origin feature/new-feature-A

# 4. 清理 worktree
cd ../claude-code-in-teams # 回到主目录
git worktree remove ../claude-book-feature-A
```

## 2. 会话管理：共享与私有并存

不同的AI编码工具提供了不同的会话管理机制。

- **共享会话 (Shared Session)**：
  - **适用场景**：两人或多人针对**同一个**紧密耦合的模块进行结对编程或问题攻坚。
  - **优点**：所有人都能看到与AI的完整交互历史，确保认知同步。
  - **风险**：容易互相干扰。需要指定一个“主驾驶员”来负责主要的Prompt输入，其他人作为“领航员”提供建议。

- **私有会话 (Private Session)**：
  - **适用场景**：大部分日常开发工作，尤其是使用Git Worktrees进行独立功能开发时。
  - **优点**：每个开发者都有自己独立的AI会话，互不干扰，可以自由探索。
  - **风险**：容易产生信息孤岛。需要通过其他沟通机制来同步关键进展。

**我们的建议**：以**私有会话为主，共享会话为辅**。在Git Worktrees提供的物理隔离基础上，让每个开发者在自己的分支和AI会话中工作，只在必要时（如联调、攻坚）开启共享会话。

## 3. 沟通机制：用“状态广播”代替“频繁询问”

为了解决私有会话带来的信息孤岛问题，我们需要一个轻量级的沟通协议来同步关键状态。

- **任务板（Jira/Trello）状态同步**：这是最基础的。当一个开发者开始让AI处理某个子任务时，应立即将任务板上对应的卡片拖到“进行中（AI）”状态。这能让所有人一眼就看出“AI正在处理这个”。
- **异步沟通工具（Slack/Teams）**：
  - **建立`#ai-collab-log`频道**：鼓励开发者在私有会话中获得关键成果或遇到重要障碍时，将简报（包括Prompt和AI的关键回答）分享到该频道。
  - **格式化日志**：
    ```
    **开发者**: 张三
    **任务**: DEV-123 实现用户认证API
    **状态**: ✅ 已完成
    **关键Prompt**: "请基于@/docs/api-design/auth.md 生成Koa路由和中间件..."
    **AI输出摘要**: 已生成符合规范的代码，测试覆盖率95%。
    **注意**: AI建议使用bcrypt的cost factor为12，我已采纳。
    ```
- **CLAUDE.md 的更新**：对于一些重要的、可复用的决策或成果（比如一个通用的Prompt模板），应及时更新到项目统一的`CLAUDE.md`或相关文档中，将其沉淀为团队的公共知识。

---

**本节小结：** 高效的实时协作始于清晰的边界和顺畅的沟通。通过使用 **Git Worktrees** 实现物理隔离，采用 **“私有为主，共享为辅”** 的会话策略，并建立基于任务板和异步沟通工具的 **“状态广播”** 机制，团队可以在享受AI带来效率提升的同时，最大程度地避免混乱和冲突，保持开发的节奏与和谐。

**下一章：** [第5章 需求拆解与任务分配](part3/chapter5.md)