# “影子”与“回放”：零风险的线上验证

对于“鹰眼”这样的高风险系统，传统的灰度发布依然存在风险——哪怕是1%的流量，一旦出错，造成的也是真实的损失。我们需要一种方法，在不影响任何真实交易的前提下，让新系统处理100%的生产流量，并将其决策与现有系统进行对比。这就是“影子模式”（Shadowing）和“流量回放”（Replaying）的用武之地。

## 核心理念：线上验证，线下执行

1.  **影子模式 (Shadowing)**：将生产环境的实时交易请求，像镜子一样复制一份，同时发送给旧的风险引擎和新的“鹰眼”引擎。旧引擎的决策被执行，新引擎的决策只被记录和分析，不产生任何实际影响。
2.  **流量回放 (Replaying)**：将生产环境的请求流持久化存储下来。这使得我们可以在任何时候，将过去某段时间的真实流量，在测试环境中无限次地“回放”，用于调试、回归测试和性能压测。

```mermaid
graph TD
    subgraph "生产环境"
        A[交易网关] --> K[Kafka: 交易事件];
        K --> OldEngine[旧风险引擎];
        K --> NewEngine_Shadow[新“鹰眼”引擎 (影子模式)];
        OldEngine -- 决策 --> A;
        NewEngine_Shadow -- 决策(仅记录) --> Log[决策日志];
    end

    subgraph "离线分析与回放"
        K --> Storage[事件存储 (如S3)];
        Log --> Analysis[AI决策比对服务];
        Storage --> Replay[流量回放系统] --> TestEnv[测试环境];
    end
```

### 第一步：“影子模式”的实现与AI决策比对

SRE工程师周工通过配置Kafka，轻松地让新旧两个系统消费同一个topic的交易事件，实现了流量的镜像。

新“鹰眼”引擎在影子模式下运行时，其决策不会返回给交易网关，而是与旧引擎的决策一起，被发送到一个专门的日志系统中。一个AI驱动的“决策比对服务”会7x24小时地监控这些日志。

**AI决策比对服务的核心Prompt:**
> 你是一位资深的风控策略分析师。请对比以下两条针对同一笔交易的决策记录。
>
> **旧引擎决策:**
> `{"transaction_id": "abc-123", "decision": "APPROVE", "rule_id": "R-101"}`
>
> **新“鹰眼”引擎决策:**
> `{"transaction_id": "abc-123", "decision": "REJECT", "risk_score": 0.95, "reason": "new_device_login"}`
>
> 请分析并归类这种差异。可能的分类有：
> - **一致通过 (Consistent Approve)**
> - **一致拒绝 (Consistent Reject)**
> - **不一致 - 新系统更严 (Inconsistent - New Engine Stricter)**
> - **不一致 - 新系统更松 (Inconsistent - New Engine Looser)**
>
> 并为“不一致”的情况，生成一条需要人工分析的警报。

这个服务每天会自动生成一份决策差异报告，让团队清晰地看到新模型在哪些场景下比旧规则更严格或更宽松，从而进行策略调整。这使得模型的“暗箱”在上线前就变得完全透明。

### 第二步：利用“流量回放”进行精准调试

在影子模式运行中，比对服务发现了一个“新系统更松”的案例：一笔被旧引擎明确拒绝的交易，被新系统放行了。这是一个高危信号。

**后端工程师的实践：**
1.  **定位事件**：从比对日志中，工程师拿到了这笔异常交易的`transaction_id`。
2.  **提取流量**：他根据ID，从Kafka的事件存储中，精确地提取出了导致这次异常决策的原始交易事件数据。
3.  **本地回放与调试**：他在自己的本地开发环境中，启动了新“鹰眼”引擎，并用刚才提取的事件数据作为输入，进行单步调试（Debug）。
4.  **发现根因**：通过调试，他发现是一个特征计算的边界条件处理错误，导致了风险评分偏低。

这个过程，就像拥有了一台“时光机”，让开发者可以精确地复现生产环境中的任何一个偶发问题，彻底告别了“在我电脑上是好的”这种传统调试难题。

### 第三步：AI生成大规模回放压测脚本

在修复了bug、准备上线新版本之前，我们需要确保这次修复没有引入新的性能问题。这时，流量回放再次发挥作用。

**SRE周工的Prompt:**
> 你是性能测试专家，精通k6测试工具。
>
> 我们在S3上存储了过去24小时的所有生产交易事件（JSON格式）。请为我编写一个k6脚本，完成以下任务：
> 1.  从S3读取这些事件数据。
> 2.  以与生产环境完全相同的速率（峰值10000 RPS）将这些事件“回放”到我们的测试环境中（地址：`http://test.eagle-eye.svc`）。
> 3.  在脚本中设置性能断言（Assertion），确保P99响应时间低于50ms，且错误率低于0.01%。

通过AI生成的压测脚本，团队可以在每次部署前，用**真实、海量**的生产流量对新版本进行一次“大考”，确保其性能和稳定性都万无一失。

---

**本节小结：** “影子”与“回放”是高风险系统上线的终极安全带。**影子模式**提供了在零风险下，用100%真实流量进行功能和业务逻辑验证的能力；**流量回放**则提供了精准复现问题和进行高仿真度压力测试的能力。AI的加入，则将决策比对、问题定界和压测脚本生成等过程自动化、智能化，使得这套原本复杂的最佳实践，能够被团队高效地执行。经过这套体系洗礼的系统，其上线后的稳定性将达到前所未有的高度。

**下一节：** [基于AI分析的智能A/B测试与模型迭代](intelligent-ab-testing.md)